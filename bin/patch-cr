#!/bin/bash
#
# Patches/applies one or more change requests (or any SQL file) to a database.

set -e

if [ -f .env ]; then
    set -o allexport
    source .env
    set +o allexport
fi

g_script_dir=$(dirname "$(readlink -f "$0")")

. "$g_script_dir/_db_utils.sh"
. "$g_script_dir/utility.sh"

g_log_level=WARNING


POSITIONAL=()
while [[ $# -gt 0 ]]
do
    key="$1"
    case $key in
        --log-level|-l)
            g_log_level="$2"; shift 2;
        ;;
        *)
        POSITIONAL+=("$1")
        shift
        ;;
    esac
done

set -- "${POSITIONAL[@]}"

g_crs=$@

if [[ ! "$g_log_level" =~ ^(DEBUG|INFO|NOTICE|WARNING|ERROR)$ ]]; then
    usage "Invalid log level: $LOG_LEVEL"
fi

if [ "$g_database" == "" ]; then
    usage 'fatal: target database not specified!'
fi

if [ "$g_crs" == "" ]; then
    usage 'fatal: you need to specify CRs!'
fi

for g_cr in $g_crs; do
    if [ -f "$g_cr" ]; then
        continue
    fi
    g_project=$(find_project "$g_cr")
    if [ "$g_project" == "" ]; then
        usage "fatal: patch ${g_cr} not found!"
    fi
    g_cr_file="$g_project/deploy/${g_cr}.sql"
    if [ ! -f "$g_cr_file" ]; then
        usage "fatal: cr file $g_cr_file not found!"
    fi
done

kickout $g_database

for g_cr in $g_crs; do

    if [ -f "$g_cr" ]; then
        g_patch_file="$g_cr"
        g_temp_file="/tmp/cr-patch-file.sql"
    else
        g_project=$(find_project "$g_cr")
        g_patch_file="$g_project/deploy/$g_cr.sql"
        g_temp_file="/tmp/$g_cr.sql"
    fi
    

    if grep -q "\/repo" "$g_patch_file"; then
        sed 's/\/repo/./g' "$g_patch_file" > "$g_temp_file"
        g_patch_file="$g_temp_file"
    fi

    psql -h $g_host -p $g_port -U $g_user -w --dbname=$g_database --file $g_patch_file -q -v ON_ERROR_STOP=1  -c "set client_min_messages to $g_log_level;"

    if [ -f "$g_temp_file" ]; then
        rm -f "$g_temp_file"
    fi

done

