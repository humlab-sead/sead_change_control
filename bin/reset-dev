#!/bin/bash

target_db="sead_staging_development"

g_port=5433
g_user=
g_verbose=no
g_host=$(dnsdomainname -A)

g_ch_sql_folder=$HOME/source/sead_clearinghouse/src/sql/

if [ -f ~/vault/.default.sead.server ]; then
    g_host=`cat ~/vault/.default.sead.server`
fi

set -e

copy-database --source sead_staging_dev_template --target $target_db --port $g_port --force --host $g_host

echo "Resetting database $target_db"

echo "Applying MEASURED VALUES patches"
bin/patch-cr --port $g_port --database $target_db \
    20240924_DDL_MEASURED_VALUES_REFACTOR \
    20240924_DML_MEASURED_VALUES_LOOKUPS

echo "Applying DENDRO patches"
bin/patch-cr --port $g_port --database $target_db \
    20241023_DML_NEW_DENDRO_LOOKUPS \
    20241031_DML_MIGRATE_DENDRO_SUBMISSION

echo "Bundling CLEARINGHOUSE SQL"

$g_ch_sql_folder/deploy_change_request.sh --target-folder /tmp --force --change 20191217_DDL_CLEARINGHOUSE_SYSTEM


echo "Applying CLEARINGHOUSE patches"
bin/patch-cr --port $g_port --database $target_db \
    /tmp/20191217_DDL_CLEARINGHOUSE_SYSTEM.sql \
    20241127_DDL_CLEARINGHOUSE_IMPORT_TABLES \
    20240112_DDL_CLEARINGHOUSE_UPLOAD_CSV
