#!/bin/bash
#
# A script to extract comments from an Excel or CSV file and upload them to a PostgreSQL database.
# NOTE:
#  - This script requires the `xlsx2csv` and `csvkit` tools to be installed.
#  - Instead of applying comments directly to the database, please consider using `csv-to-sql` instead and
#    and replacing sead_model/SEAD_DATABASE_MODEL/deploy/comments.sql with the generated SQL file.


source .env


g_script_dir=$(dirname "$(readlink -f "$0")")
g_script_name="${BASH_SOURCE[0]}"

. "$g_script_dir/../_db_utils.sh"

g_filename=resources/tables_and_columns.xlsx
g_delimiter=$','

# usage_message=$usage_message \
# $(cat <<EOF
#     --delimiter DELIMITER               Field delimiter for CSV files)
# EOF
# )

while [[ $1 == --* || $1 == -h ]]; do
    case $1 in
        --delimiter) g_delimiter="$2"; shift 2 ;;
        -h|--help)   usage ;;
        *)           usage "unknown option $1" ;;
    esac
done

g_filename=${1:-$g_filename}

if [ "$g_filename" == "" ]; then
    usage "filename is missing";
fi

function dbexec() {
    local sql="$1"
    psql -v ON_ERROR_STOP=1 -h $g_host -U $g_user -d $g_database -p $g_port --no-password --command "$sql"
    if [ $? -ne 0 ];  then
        echo "error: psql command failed! script aborted." >&2
        exit 64
    fi
}

function extract_comments_to_csv()
{
    local filename=$1
    local target_filename=$2
    local delimiter=${3:-$','}

    if [[ "$filename" =~ \.xlsx$ ]]; then
        if command -v xlsx2csv &> /dev/null
        then
            xlsx2csv "$filename" -n "Tables & Columns" -d 'x09' | csvcut --tabs -c schema_name,table_name,column_name,comment | csvformat -T > $target_filename
        else
            usage "xlsx2csv is not installed. Please install it using 'brew install xlsx2csv' or 'pipx install xlsx2csv'"
        fi
    elif [[ "$filename" =~ \.csv$ ]]; then
        csvcut -d $delimiter -c schema_name,table_name,column_name,comment "$filename"  | csvformat -T > $target_filename
    else
        usage "Unsupported file format. Only .xlsx and .csv files are supported."
    fi
}


function upload_csv()
{
    local filename=$1
    dbexec "call sead_utility.setup_comments();"
    dbexec "\copy sead_utility.temp_comments (schema_name,table_name,column_name,comment) from '$filename' with delimiter E'\t' csv header;" 
    dbexec "call sead_utility.sync_comments();" 
}

g_target_filename=/tmp/sead_comments.$(date +%Y%m%d%H%M%S).csv

echo extract_comments_to_csv "$g_filename" "$g_target_filename" "$g_delimiter"
echo upload_csv "$g_target_filename"

# rm -f $g_target_filename

echo "Comments (CSV file $g_target_filename) uploaded to database"